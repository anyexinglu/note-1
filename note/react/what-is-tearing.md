# What is tearing?

本文只是对原文的简单翻译，可能会有所出入，详细可以[查看原文](https://github.com/reactwg/react-18/discussions/69)

## Overview

tearing 是图形编程中传统上使用的一个术语，用于指代视觉上的不一致。

例如，在视频中，[屏幕 tearing](https://en.wikipedia.org/wiki/Screen_tearing)是指您在单个屏幕中看到多个帧，这会使视频看起来“有毛病”。在用户界面中，“tearing” 是指 UI 为同一状态显示了多个值。例如，您可能会在列表中显示同一商品的不同价格，或者您提交了错误价格的表单，甚至在访问过时的商店值时崩溃。

由于 JavaScript 是单线程的，这个问题在 web 开发中一般不会出现。但是在 React 18 中，并发渲染使这个问题成为可能，因为 React 在渲染期间会产生。这意味着当使用 `startTransition` 或 `Suspense` 等并发功能时，React 可以暂停以让其他工作发生。在这些暂停之间，更新可能会潜入更改用于呈现的数据，这可能导致 UI 为相同的数据显示两个不同的值。

这个问题不是 React 特有的，它是并发的必然结果。如果您希望能够中断渲染以响应用户输入以获得更具响应性的体验，则您需要对正在渲染的数据发生变化并导致用户界面 tearing 具有弹性。

flarnie 在[此处](https://www.youtube.com/watch?v=V1Ly-8Z1wQA&t=1079s)的一次演讲中解释了此问题，但我们将通过解释同步渲染和并发渲染期间发生的情况来简要概述此问题。

### Synchronous rendering

看看下图。

在第一个面板中，我们开始渲染 React 树。我们得到一个需要访问一些外部数据源并获取颜色值的组件。外部数据源表示颜色为蓝色，因此该组件呈现蓝色。

在第二个面板中，由于我们不是并发渲染，React 会继续渲染所有组件而不会停止。既然我们没有停止（或“yield”），那么外部数据源就不可能改变。因此，所有组件在外部存储中都获得相同的值。

在第三个面板中，我们看到所有组件都呈现为蓝色，并且它们看起来都一样。 UI 始终以一致的状态显示，因为您看到的所有内容在屏幕上的任何地方都以相同的值呈现。

最后，在第四个面板中，store 更新。这是因为 React 完成了，并允许其他工作发生。如果在 React 未渲染时 store 更新，那么下一次 React 渲染树时，我们将从第一个面板重新开始，所有组件都将获得相同的值。

这就是为什么在并发渲染之前，以及在大多数其他 UI 框架中，UI 总是一致地渲染。这是 React 在 React 17 中工作的方式，默认形式在 React 18 中，当您不使用并发功能时。

![1](https://user-images.githubusercontent.com/2440089/124805929-23f7e080-df2a-11eb-99c7-776812e89908.png)

### Concurrent rendering

大多数情况下，并发渲染会产生一致的 UI，但也有可能在适当条件下的边缘情况导致问题。要了解会发生什么，请参见下图。

我们像以前一样启动第一个面板，并将组件渲染为蓝色。

这是我们可以开始不同的地方。

由于我们使用的是并发特性，我们使用的是并发渲染，React 可以在它完成之前停止工作，“让步”给其他工作。这对响应性来说是一个巨大的好处，因为用户能够在没有 React 阻止的情况下与页面交互。在这种情况下，假设用户单击了一个将 store 从蓝色变为红色的按钮。在并发渲染之前，这甚至是不可能处理的。页面对用户来说似乎是暂停的，他们无法点击任何东西。但是通过并发渲染，React 可以让点击发生，因此页面对用户来说是流畅和可交互的。

此功能的结果是用户交互（或其他工作，如网络请求或超时）可以更改用于呈现您在屏幕上看到的内容的外部状态中的值。这是可能导致问题的边缘情况。在第二个面板中，我们看到 React 已经屈服，并且外部 store 已经根据用户交互发生了变化。

问题是第一个组件已经呈现蓝色（因为那是当时 store 的值），但是在此之后呈现的任何组件都将获得当前值，现在是红色。在第三个面板中，这正是发生的事情。现在，访问外部状态的组件渲染并获取当前值，即红色。

最后，在最后一个面板中，我们可以看到以前始终为蓝色的组件现在是红色和蓝色的混合。他们为相同的数据显示两个不同的值。这种边缘情况是 “tearing”。

![2](https://user-images.githubusercontent.com/2440089/124805949-29edc180-df2a-11eb-9621-4cd9c5d0bc5c.png)
